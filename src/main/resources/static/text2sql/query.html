<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>AI生成式图表</title>
	<link href="/webjars/bootstrap/5.3.5/css/bootstrap.min.css" rel="stylesheet">
	<script src="/webjars/jquery/3.7.1/jquery.min.js"></script>
	<script src="/webjars/echarts/5.5.0/echarts.min.js"></script>
	<style>
		body {
			padding-top: 40px;
			background-color: #eee;
		}
		#submit {
			width: 200px;
		}
		#echarts {
			padding-top: 50px;
			height: 400px;
		}
		#result {
			padding-top: 50px;
			white-space: pre;
		}
	</style>
	<script>
		$(function () {
			var queryingText = false;
			var chart;
			var form = $('#query-form');
			var input = form.find('input[name="query"]');
			var submit = form.find('submit');
			input.keypress(function(event) {
				if (event.which === 13) {
					input.blur();
					form.submit();
					event.preventDefault();
				}
			});
			$.ajaxSetup({
			  beforeSend: function() {
			  	if (!queryingText) {
			  		input.attr('readonly', 'readonly');
					submit.attr('disabled', 'disabled').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>正在查询...');
			  	}
			  },
			  complete: function() {
			  	if (!queryingText) {
					input.removeAttr('readonly');
					submit.removeAttr('disabled').html('查询');
				}
			  }
			});

			$('#query-form').on('submit', function (e) {
				var query = $.trim(input.val());
				if (!query) {
					return false;
				}
				if (chart != null) {
					chart.clear();
				}
				$('#echarts,#result').remove();
				$.post('echarts', {'query': query}, function(data) {
					try {
						if (typeof data == 'string') {
							data = $.trim(data);
							if (data.startsWith('{') && data.endsWith('}')) {
								data = JSON.parse(data);
							} else {
								$('<div id="result"/>').insertAfter(form).html(data);
								return false;
							}
						}
						$(data.series).each(function(index, item) {
							item.label = {
								'show': true,
								'position': 'top'
							};
						});
						$('<div id="echarts"/>').insertAfter(form);
						chart = echarts.init(document.getElementById('echarts'));
						chart.setOption(data);
					} catch(e) {
					}
					if ($('#echarts').find('canvas').length == 0) {
						$('#echarts').remove();
						// fallback to text query
						queryingText = true;
						$.post('query', {'query': query}, function(data) {
							$('<div id="result"/>').insertAfter(form).html(data);
							queryingText = false;
						});
					}
				});
				return false;
			});

		});
	</script>
</head>

<body>
<div class="container">
	<form id="query-form">
		<div class="input-group">
			<input type="text" name="query" class="form-control rounded" placeholder="请输入关于数据统计分析的问题？"/>
			<button type="submit" class="btn btn-primary">查询</button>
		</div>
	</form>
</div>
</body>

</html>
